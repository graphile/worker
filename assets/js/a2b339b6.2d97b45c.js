"use strict";(self.webpackChunkgraphile_worker=self.webpackChunkgraphile_worker||[]).push([[5708],{5318:(e,n,r)=>{r.d(n,{Zo:()=>u,kt:()=>m});var t=r(7378);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=t.createContext({}),p=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},u=function(e){var n=p(e.components);return t.createElement(s.Provider,{value:n},e.children)},d="mdxType",k={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},c=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(r),c=o,m=d["".concat(s,".").concat(c)]||d[c]||k[c]||a;return r?t.createElement(m,i(i({ref:n},u),{},{components:r})):t.createElement(m,i({ref:n},u))}));function m(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=c;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[d]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=r[p];return t.createElement.apply(null,i)}return t.createElement.apply(null,r)}c.displayName="MDXCreateElement"},5203:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>k,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var t=r(5773),o=(r(7378),r(5318));const a={title:"Library: running jobs",sidebar_position:60,sidebar_label:"Running jobs"},i=void 0,l={unversionedId:"library/run",id:"library/run",title:"Library: running jobs",description:"graphile-worker can be used as a library inside your Node.js application.",source:"@site/docs/library/run.md",sourceDirName:"library",slug:"/library/run",permalink:"/docs/library/run",draft:!1,editUrl:"https://github.com/graphile/worker/tree/main/website/docs/library/run.md",tags:[],version:"current",sidebarPosition:60,frontMatter:{title:"Library: running jobs",sidebar_position:60,sidebar_label:"Running jobs"},sidebar:"tutorialSidebar",previous:{title:"Library",permalink:"/docs/library/"},next:{title:"Queueing jobs",permalink:"/docs/library/queue"}},s={},p=[{value:"<code>run()</code>",id:"run",level:2},{value:"<code>runOnce()</code>",id:"runonce",level:2},{value:"<code>runMigrations()</code>",id:"runmigrations",level:2},{value:"<code>RunnerOptions</code>",id:"runneroptions",level:2},{value:"<code>Runner</code>",id:"runner",level:2},{value:"Example: <code>runner.addJob()</code>",id:"example-runneraddjob",level:3},{value:"Example: <code>runner.events</code>",id:"example-runnerevents",level:3},{value:"<code>WorkerEvents</code>",id:"workerevents",level:2}],u={toc:p},d="wrapper";function k(e){let{components:n,...r}=e;return(0,o.kt)(d,(0,t.Z)({},u,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"graphile-worker")," can be used as a library inside your Node.js application.\nThere are two main use cases for this: running jobs, and queueing jobs. Here are\nthe APIs for running jobs."),(0,o.kt)("h2",{id:"run"},(0,o.kt)("inlineCode",{parentName:"h2"},"run()")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function run(options: RunnerOptions): Promise<Runner>;\n")),(0,o.kt)("p",null,"Runs until either stopped by a signal event like ",(0,o.kt)("inlineCode",{parentName:"p"},"SIGINT")," or by calling the\n",(0,o.kt)("inlineCode",{parentName:"p"},"stop()")," method on the resolved object."),(0,o.kt)("p",null,"The resolved ","\u2018","Runner","\u2019"," object has a number of helpers on it, see\n",(0,o.kt)("a",{parentName:"p",href:"#runner"},"Runner")," for more information."),(0,o.kt)("h2",{id:"runonce"},(0,o.kt)("inlineCode",{parentName:"h2"},"runOnce()")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function runOnce(options: RunnerOptions): Promise<void>;\n")),(0,o.kt)("p",null,"Equivalent to running the CLI with the ",(0,o.kt)("inlineCode",{parentName:"p"},"--once")," flag. The function will run\nuntil there are no runnable jobs left, and then resolve."),(0,o.kt)("h2",{id:"runmigrations"},(0,o.kt)("inlineCode",{parentName:"h2"},"runMigrations()")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function runMigrations(options: RunnerOptions): Promise<void>;\n")),(0,o.kt)("p",null,"Equivalent to running the CLI with the ",(0,o.kt)("inlineCode",{parentName:"p"},"--schema-only")," option. Runs the\nmigrations and then resolves."),(0,o.kt)("h2",{id:"runneroptions"},(0,o.kt)("inlineCode",{parentName:"h2"},"RunnerOptions")),(0,o.kt)("p",null,"The following options for these methods are available."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"concurrency"),": The equivalent of the CLI ",(0,o.kt)("inlineCode",{parentName:"li"},"--jobs")," option with the same default\nvalue."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"noHandleSignals"),": If set true, we won","'","t install signal handlers and\nit","'","ll be up to you to handle graceful shutdown of the worker if the\nprocess receives a signal."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pollInterval"),": The equivalent of the CLI ",(0,o.kt)("inlineCode",{parentName:"li"},"--poll-interval")," option with the\nsame default value."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"logger"),": To change how log messages are output you may provide a custom\nlogger; see ",(0,o.kt)("a",{parentName:"li",href:"/docs/library/logger"},(0,o.kt)("inlineCode",{parentName:"a"},"Logger")),"."),(0,o.kt)("li",{parentName:"ul"},"the database is identified through one of these options:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"connectionString"),": A PostgreSQL\n",(0,o.kt)("a",{parentName:"li",href:"/docs/connection-string"},"connection string")," to the database containing the\njob queue, or"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pgPool"),": A ",(0,o.kt)("inlineCode",{parentName:"li"},"pg.Pool")," instance to use."))),(0,o.kt)("li",{parentName:"ul"},"the tasks to execute are identified through one of these options:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"taskDirectory"),": A path string to a directory containing the task handlers."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"taskList"),": An object with the task names as keys and a corresponding task\nhandler functions as values."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"schema")," can be used to change the default ",(0,o.kt)("inlineCode",{parentName:"li"},"graphile_worker")," schema to\nsomething else (equivalent to ",(0,o.kt)("inlineCode",{parentName:"li"},"--schema")," on the CLI)."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"forbiddenFlags")," see ",(0,o.kt)("a",{parentName:"li",href:"/docs/forbidden-flags"},"Forbidden flags"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"events"),": pass your own ",(0,o.kt)("inlineCode",{parentName:"li"},"new EventEmitter()")," if you want to customize the\noptions, get earlier events (before the runner object resolves), or want to\nget events from alternative Graphile Worker entrypoints."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"noPreparedStatements"),": Set true if you want to prevent the use of prepared\nstatements, for example if you wish to use Graphile Worker with an external\nPostgreSQL connection pool. Enabling this setting may have a small performance\nimpact.")),(0,o.kt)("p",null,"Exactly one of either ",(0,o.kt)("inlineCode",{parentName:"p"},"taskDirectory")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"taskList")," must be provided (except for\n",(0,o.kt)("inlineCode",{parentName:"p"},"runMigrations")," which doesn","'","t require a task list)."),(0,o.kt)("p",null,"One of these must be provided (in order of priority):"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pgPool")," pg.Pool instance"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/connection-string"},(0,o.kt)("inlineCode",{parentName:"a"},"connectionString"))," setting"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DATABASE_URL")," envvar"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.postgresql.org/docs/current/libpq-envars.html"},"PostgreSQL environmental variables"),",\nincluding at least ",(0,o.kt)("inlineCode",{parentName:"li"},"PGDATABASE")," (NOTE: not all envvars are supported)")),(0,o.kt)("h2",{id:"runner"},(0,o.kt)("inlineCode",{parentName:"h2"},"Runner")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"run")," method above resolves to a ","\u2018","Runner","\u2019"," object that has the\nfollowing methods and properties:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"stop(): Promise<void>")," ","\u2014"," stops the runner from accepting new jobs, and\nreturns a promise that resolves when all the in progress tasks (if any) are\ncomplete."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"addJob: AddJobFunction")," ","\u2014"," see ",(0,o.kt)("a",{parentName:"li",href:"/docs/library/add-job"},(0,o.kt)("inlineCode",{parentName:"a"},"addJob")),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"promise: Promise<void>")," ","\u2014"," a promise that resolves once the runner has\ncompleted."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"events: WorkerEvents")," ","\u2014"," a Node.js ",(0,o.kt)("inlineCode",{parentName:"li"},"EventEmitter")," that exposes certain\nevents within the runner (see ",(0,o.kt)("a",{parentName:"li",href:"#workerevents"},(0,o.kt)("inlineCode",{parentName:"a"},"WorkerEvents")),").")),(0,o.kt)("h3",{id:"example-runneraddjob"},"Example: ",(0,o.kt)("inlineCode",{parentName:"h3"},"runner.addJob()")),(0,o.kt)("p",null,"See ",(0,o.kt)("a",{parentName:"p",href:"/docs/library/add-job"},(0,o.kt)("inlineCode",{parentName:"a"},"addJob"))," for more details."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'await runner.addJob("testTask", {\n  thisIsThePayload: true,\n});\n')),(0,o.kt)("h3",{id:"example-runnerevents"},"Example: ",(0,o.kt)("inlineCode",{parentName:"h3"},"runner.events")),(0,o.kt)("p",null,"See ",(0,o.kt)("a",{parentName:"p",href:"#workerevents"},(0,o.kt)("inlineCode",{parentName:"a"},"WorkerEvents"))," for more details."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'runner.events.on("job:success", ({ worker, job }) => {\n  console.log(`Hooray! Worker ${worker.workerId} completed job ${job.id}`);\n});\n')),(0,o.kt)("h2",{id:"workerevents"},(0,o.kt)("inlineCode",{parentName:"h2"},"WorkerEvents")),(0,o.kt)("p",null,"We support a large number of events via an EventEmitter. You can either retrieve\nthe event emitter via the ",(0,o.kt)("inlineCode",{parentName:"p"},"events")," property on the ",(0,o.kt)("inlineCode",{parentName:"p"},"Runner")," object, or you can\ncreate your own event emitter and pass it to Graphile Worker via the\n",(0,o.kt)("inlineCode",{parentName:"p"},"WorkerOptions.events")," option (this is primarily useful for getting events from\nthe other Graphile Worker entrypoints)."),(0,o.kt)("p",null,"Details of what events we support and what data is available on the event\npayload is detailed below in TypeScript syntax:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'export type WorkerEvents = TypedEventEmitter<{\n  /**\n   * When a worker pool is created\n   */\n  "pool:create": { workerPool: WorkerPool };\n\n  /**\n   * When a worker pool attempts to connect to PG ready to issue a LISTEN\n   * statement\n   */\n  "pool:listen:connecting": { workerPool: WorkerPool };\n\n  /**\n   * When a worker pool starts listening for jobs via PG LISTEN\n   */\n  "pool:listen:success": { workerPool: WorkerPool; client: PoolClient };\n\n  /**\n   * When a worker pool faces an error on their PG LISTEN client\n   */\n  "pool:listen:error": {\n    workerPool: WorkerPool;\n    error: any;\n    client: PoolClient;\n  };\n\n  /**\n   * When a worker pool is released\n   */\n  "pool:release": { pool: WorkerPool };\n\n  /**\n   * When a worker pool starts a graceful shutdown\n   */\n  "pool:gracefulShutdown": { pool: WorkerPool; message: string };\n\n  /**\n   * When a worker pool graceful shutdown throws an error\n   */\n  "pool:gracefulShutdown:error": { pool: WorkerPool; error: any };\n\n  /**\n   * When a worker is created\n   */\n  "worker:create": { worker: Worker; tasks: TaskList };\n\n  /**\n   * When a worker release is requested\n   */\n  "worker:release": { worker: Worker };\n\n  /**\n   * When a worker stops (normally after a release)\n   */\n  "worker:stop": { worker: Worker; error?: any };\n\n  /**\n   * When a worker is about to ask the database for a job to execute\n   */\n  "worker:getJob:start": { worker: Worker };\n\n  /**\n   * When a worker calls get_job but there are no available jobs\n   */\n  "worker:getJob:error": { worker: Worker; error: any };\n\n  /**\n   * When a worker calls get_job but there are no available jobs\n   */\n  "worker:getJob:empty": { worker: Worker };\n\n  /**\n   * When a worker is created\n   */\n  "worker:fatalError": { worker: Worker; error: any; jobError: any | null };\n\n  /**\n   * When a job is retrieved by get_job\n   */\n  "job:start": { worker: Worker; job: Job };\n\n  /**\n   * When a job completes successfully\n   */\n  "job:success": { worker: Worker; job: Job };\n\n  /**\n   * When a job throws an error\n   */\n  "job:error": { worker: Worker; job: Job; error: any };\n\n  /**\n   * When a job fails permanently (emitted after job:error when appropriate)\n   */\n  "job:failed": { worker: Worker; job: Job; error: any };\n\n  /**\n   * When a job has finished executing and the result (success or failure) has\n   * been written back to the database\n   */\n  "job:complete": { worker: Worker; job: Job; error: any };\n\n  /**\n   * When the runner is terminated by a signal\n   */\n  gracefulShutdown: { signal: Signal };\n\n  /**\n   * When the runner is stopped\n   */\n  stop: {};\n}>;\n')))}k.isMDXComponent=!0}}]);